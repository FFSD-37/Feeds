<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Home-Feed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- your CSS, etc. -->
    <link
      rel="icon"
      type="image/*"
      href="https://ik.imagekit.io/FFSD0037/logo.jpeg?updatedAt=1746701257780"
    />
  </head>
  <body>
    <h1>Latest Posts</h1>
    <div id="posts-container">
      <% if (!posts || posts.length === 0) { %>
      <p>No posts to display.</p>
      <% } else { %> <% posts.forEach(function(post) { %> 
      <div
        class="post"
        data-id="<%= post.id %>"
        data-createdat="<%= post.createdAt.toISOString() %>"
      >
        <div class="post-header">
          <a
            href="/profile/<%= post.author %>"
            style="text-decoration: none; color: black"
            ><span class="username"><%= post.author %></span></a
          >

          <% 
            function timeAgo(date) {
              const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
              const intervals = {
                year: 31536000,
                mon: 2592000,
                w: 604800,
                d: 86400,
                h: 3600,
                m: 60,
              };
              for (const [unit, sec] of Object.entries(intervals)) {
                const count = Math.floor(seconds / sec);
                if (count >= 1) return `${count} ${unit}`;
              }
              return "just now";
            }
          %>

          <span class="post-time" data-created="<%= post.createdAt %>"
            ><%= timeAgo(new Date(post.createdAt)) %></span
          >

          <div
            class="post-options"
            id="postOptions"
            onclick="openpostdropdown()"
          >
            <a style="text-decoration: none; color: black">•••</a>
          </div>
          <div class="dropdown-menu" id="socialDropdown">
            <div class="menu-item danger" onclick="openReportModal('<%= post.id %>')">
              Report
            </div>
            <div
              class="menu-item normal"
              onclick="postOverlay('<%- post.url %>','<%- post.id %>','<%- post.content %>', '<%- post.createdAt instanceof Date ? post.createdAt.toISOString() : post.createdAt %>', '<%- post.author %>', '<%- post.liked %>', '<%- post.saved %>')"
            >
              Go to post
            </div>
            <div
              class="menu-item normal"
              id="btnShareProfile"
              onclick="shareTo('<%= post.author %>')"
            >
              Share to...
            </div>
            <div
              class="menu-item normal"
              onclick="copyURL('<%= post.author %>')"
            >
              Copy link
            </div>
            <div class="menu-item normal">
              <a href="/settings" style="text-decoration: none; color: white"
                >About this account</a
              >
            </div>
            <div class="menu-item normal" onclick="closepostdropdown()">
              Cancel
            </div>
          </div>
        </div>
        <% if(post.type === "Img") { %>
        <div
          class="post-content"
          onclick="postOverlay('<%- post.url %>','<%- post.id %>', '<%- post.content %>', '<%- post.createdAt instanceof Date ? post.createdAt.toISOString() : post.createdAt %>', '<%- post.author %>', '<%- post.liked %>', '<%- post.saved %>')"
        >
          <img class="post-on-home-page" src="<%= post.url %>" />
        </div>
        <% } else { %>
        <div class="post-content" onclick="reelOpen('<%= post %>')">
          <video
            class="post-on-home-page"
            src="<%= post.url %>&&tr=w-640,h-640"
            loop
            preload="metadata"
          ></video>
        </div>
        <% } %> <% if (type !== "Kids" && type !== "Student") { %>
        <div class="post-actions">
          <div class="action-icon" onclick="likePost('<%= post.id %>', this)">
            <% if(post.liked) { %>
            <i class="fas fa-heart"></i>
            <% } else { %>
            <i class="far fa-heart"></i>
            <% } %>
          </div>
          <% if(post.type === "Img") { %>
          <div
            class="action-icon"
            onclick="postOverlay('<%- post.url %>','<%- post.id %>', '<%- post.content %>', '<%- post.createdAt instanceof Date ? post.createdAt.toISOString() : post.createdAt %>', '<%- post.author %>', '<%- post.liked %>', '<%- post.saved %>')"
            id="comment-button-post"
          >
            <i class="far fa-comment"></i>
          </div>
          <% } %>
          <div class="action-icon">
            <i class="fas fa-share" onclick="shareTo('<%= post.author %>')"></i>
          </div>
          <!-- <div
            class="last-action-icon"
            onclick="savePost('<%= post.id %>', this)"
          >
            <i class="fa-solid fa-floppy-disk"></i>
          </div> -->
        </div>
        <% } %>
      </div>
      <% }); %> <% } %>
    </div>
    <script>
      function shareTo(uname) {
        if (navigator.share) {
          navigator
            .share({
              title: "My Profile",
              url: `http://localhost:3000/profile/${uname}`,
            })
            .catch((err) => {
              console.log("Error sharing:", err);
            });
        } else {
          alert("Share this URL: " + window.location.href);
        }
      }

      function copyURL(uname) {
        navigator.clipboard
          .writeText(window.location.href)
          .then(() => alert("Profile URL copied!"))
          .catch((err) => console.error("Could not copy text: ", err));
      }
    </script>
  </body>
</html>
