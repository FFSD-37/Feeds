<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notifications</title>
    <link rel="stylesheet" href="../css/notifications.css" />
    <link rel="icon" type="image/*" href="https://ik.imagekit.io/FFSD0037/logo.jpeg?updatedAt=1746701257780">
  </head>

  <body>
    <%- include('sidebar') %>
    
    <div class="container">
      <div class="header">
        <span class="header-icon">🔔</span>
        <h1>Notifications</h1>
        <% if(allNotifications && allNotifications.length > 0){ %>
        <span class="header-badge">Total: <%= allNotifications.length %></span>
        <% } %>
      </div>

      <div class="notifications-wrapper">
        <% if(allNotifications && allNotifications.length > 0){ %>
          <% allNotifications.forEach(function(noti) { 
            let icon = '📩';
            let message = '';
            
            if(noti.msgSerial === 1) {
              icon = '👤';
              message = '<a href="/profile/' + noti.userInvolved + '">' + noti.userInvolved + '</a> started following you.';
            } else if(noti.msgSerial === 2) {
              icon = '❤️';
              message = '<a href="/profile/' + noti.userInvolved + '">' + noti.userInvolved + '</a> liked your comment.';
            } else if(noti.msgSerial === 3) {
              icon = '👍';
              message = '<a href="/profile/' + noti.userInvolved + '">' + noti.userInvolved + '</a> liked your post.';
            } else if(noti.msgSerial === 4) {
              icon = '🤝';
              message = '<a href="/profile/' + noti.userInvolved + '">' + noti.userInvolved + '</a> requested to follow you.';
            } else if(noti.msgSerial === 5) {
              icon = '👁️';
              message = '<a href="/profile/' + noti.userInvolved + '">' + noti.userInvolved + '</a> has viewed your profile.';
            } else if(noti.msgSerial === 6) {
              icon = '🪙';
              message = 'You\'ve received <span class="coin-badge">🪙 ' + noti.coin + ' coins</span>';
            } else if(noti.msgSerial === 7) {
              icon = '👋';
              message = '<a href="/profile/' + noti.userInvolved + '">' + noti.userInvolved + '</a> has unfollowed you.';
            } else if(noti.msgSerial === 8) {
              icon = '👋';
              message = '<a href="/profile/' + noti.userInvolved + '">' + noti.userInvolved + '</a> has commented on your post.';
            } else if(noti.msgSerial === 9) {
              icon = '❤️';
              message = '<a href="/profile/' + noti.userInvolved + '">' + noti.userInvolved + '</a> has liked your comment.';
            }

          %>
          
          <div class="notification-item">
            <div class="notification-icon">
              <%= icon %>
            </div>
            <div class="notification-content">
              <div class="notification-message">
                <%- message %>
              </div>
              <div class="notification-time">
                <span>📅</span>
                <%= new Date(noti.createdAt).toLocaleDateString() %>
                <span>•</span>
                <span>🕐</span>
                <%= new Date(noti.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
              </div>
            </div>
            <% if(noti.msgSerial === 4) { %>
            <div class="notification-action">
              <button class="btn-follow" onclick="followback('<%= noti.userInvolved %>', this)">
                Follow back
              </button>
            </div>
            <% } %>
          </div>
          <% }); %>
        <% } else { %>
          <div class="no-data">
            <div class="no-data-icon">🔔</div>
            <h2>No notifications yet</h2>
            <p>When you get notifications, they'll show up here</p>
          </div>
        <% } %>
      </div>
    </div>

    <script>
      function followback(username, button) {
        button.disabled = true;
        button.textContent = 'Following...';
        
        fetch(`/followback/${username}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            button.textContent = 'Following';
            button.classList.add('followed');
            
            setTimeout(() => {
              button.closest('.notification-item').style.animation = 'slideOut 0.4s ease';
              setTimeout(() => {
                button.closest('.notification-item').style.display = 'none';
              }, 400);
            }, 1500);
          })
          .catch((error) => {
            console.error(error);
            button.disabled = false;
            button.textContent = 'Follow back';
            alert('Failed to follow. Please try again.');
          });
      }
    </script>
  </body>
</html>